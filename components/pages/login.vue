
<template>
  <div tabindex="-1" role="group" style="outline: none">
    <div class="c--auth-box">
      <div class="c--auth-box-header">
        <div class="c--auth-box-header-svg"></div>
      </div>
      <div class="auth--body" dir="ltr">
        <div class="auth--logo-box">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 240 78"
            class="auth--logo"
            lang="fa"
          >
            <path
              d="M175.418 45.812a6.5109 6.5109 0 0 1-.531 2.6184 6.5133 6.5133 0 0 1-1.539 2.1846 6.775 6.775 0 0 1-2.238 1.4981 6.7788 6.7788 0 0 1-2.644.509 7.0029 7.0029 0 0 1-2.767-.487 6.9945 6.9945 0 0 1-2.352-1.5352 6.5485 6.5485 0 0 1-1.534-2.2024 6.5577 6.5577 0 0 1-.521-2.6328v-4.6204h-6.573v4.8718a13.1002 13.1002 0 0 0 .976 5.0978 13.1053 13.1053 0 0 0 2.879 4.3191 13.4143 13.4143 0 0 0 9.922 3.7608 13.047 13.047 0 0 0 9.638-3.7608c.215-.2149.43-.4491.628-.6791.165.1827.333.3632.509.5395a13.4143 13.4143 0 0 0 9.922 3.7607 13.047 13.047 0 0 0 5.207-.8845 13.044 13.044 0 0 0 4.431-2.8762 13.15 13.15 0 0 0 2.857-4.3246c.657-1.6166.985-3.3477.966-5.0924v-22.717h-6.542v22.4635a6.507 6.507 0 0 1-.521 2.644 6.5215 6.5215 0 0 1-1.548 2.2062 6.7752 6.7752 0 0 1-2.238 1.4982 6.7841 6.7841 0 0 1-2.644.509 7.0047 7.0047 0 0 1-2.767-.487 6.9945 6.9945 0 0 1-2.352-1.5352 6.5508 6.5508 0 0 1-1.534-2.2025 6.5403 6.5403 0 0 1-.521-2.6327v-34.109h-6.569V45.812ZM125.66 55.5025c.215-.2149.43-.4513.63-.6834.167.1848.337.3675.515.5459a13.412 13.412 0 0 0 9.922 3.7607 13.0462 13.0462 0 0 0 5.208-.8841 13.0532 13.0532 0 0 0 4.431-2.8766 13.1824 13.1824 0 0 0 2.857-4.3246 13.182 13.182 0 0 0 .966-5.0924V23.231h-6.542v22.4635a6.4918 6.4918 0 0 1-.522 2.6441 6.5049 6.5049 0 0 1-1.547 2.2062 6.796 6.796 0 0 1-2.238 1.4983 6.7835 6.7835 0 0 1-2.645.5088 7 7 0 0 1-2.766-.4872 6.9981 6.9981 0 0 1-2.353-1.535 6.5498 6.5498 0 0 1-1.534-2.2025 6.5563 6.5563 0 0 1-.52-2.6327v-22.528h-6.574V45.832a6.508 6.508 0 0 1-.522 2.6441 6.5076 6.5076 0 0 1-1.548 2.2062 6.7801 6.7801 0 0 1-2.237 1.4983 6.7871 6.7871 0 0 1-2.645.5089H78.0016v6.5737h38.0974a13.0322 13.0322 0 0 0 5.167-.8982 13.0393 13.0393 0 0 0 4.394-2.8625Z"
              fill="#262626"
            ></path>
            <path
              d="M161.289 12.0183h-6.573v24.98h6.573v-24.98ZM228.793 61.8525l-16.163 8.6394 2.061 3.8549 16.162-8.6394-2.06-3.8549ZM222.025 59.1946a17.3138 17.3138 0 0 0 12.694-5.278 17.3564 17.3564 0 0 0 3.958-5.8208 17.3478 17.3478 0 0 0 1.32-6.9142 17.3477 17.3477 0 0 0-1.32-6.9141 17.3574 17.3574 0 0 0-3.958-5.8208 17.3166 17.3166 0 0 0-12.703-5.278 17.3467 17.3467 0 0 0-11.185 3.8553 24.084 24.084 0 0 0-1.55 1.4227c-.209.2106-.809.8739-1.8 1.9899l3.285 3.3181 17.223 17.2221a9.189 9.189 0 0 1-5.973 1.4527h-14.535v6.8059h14.544v-.0408Zm-4.969-28.4399a9.241 9.241 0 0 1 4.96-.8596 10.83 10.83 0 0 1 4.318.8276 10.8393 10.8393 0 0 1 3.634 2.4754 10.8916 10.8916 0 0 1 2.478 3.6475c.568 1.3724.849 2.8466.825 4.3317a9.3664 9.3664 0 0 1-.86 4.9621l-15.355-15.3847ZM192.26 73.9374c2.729-1.1314 4.025-4.2614 2.894-6.991-1.132-2.7295-4.262-4.0251-6.991-2.8937-2.73 1.1314-4.026 4.2614-2.894 6.991 1.131 2.7295 4.261 4.0251 6.991 2.8937ZM144.763 73.9627c2.743-1.0975 4.076-4.2105 2.979-6.9532-1.098-2.7427-4.211-4.0763-6.953-2.9789-2.743 1.0975-4.077 4.2106-2.979 6.9533 1.097 2.7426 4.21 4.0763 6.953 2.9788Z"
              fill="#262626"
            ></path>
            <path
              d="M134.123 73.9378c2.729-1.1305 4.025-4.2594 2.895-6.9886-1.131-2.7292-4.26-4.0253-6.989-2.8948-2.729 1.1305-4.025 4.2594-2.895 6.9886 1.131 2.7292 4.26 4.0253 6.989 2.8948ZM105.536 42.3488c2.954 0 5.349-2.3947 5.349-5.3488s-2.395-5.3489-5.349-5.3489-5.349 2.3948-5.349 5.3489c0 2.9541 2.395 5.3488 5.349 5.3488Z"
              fill="#262626"
            ></path>
            <path
              d="M96.8853 41.941c2.7293-1.1305 4.0257-4.2594 2.8948-6.9886-1.1305-2.7293-4.2594-4.0253-6.9886-2.8948-2.7292 1.1305-4.0253 4.2594-2.8948 6.9886 1.1305 2.7292 4.2594 4.0253 6.9886 2.8948ZM0 75.2975c0-.4987.1666-.9558.458-1.3298l1.749-2.3271c.6663-.8311 1.2909-1.7037 1.9988-2.4932l1.9988-2.3687 1.749-1.9946.4996-.5402.1666-.3325.2915-1.6206a87.347 87.347 0 0 1 2.207-8.8512c.4997-1.5791 1.041-3.1166 1.624-4.6957.4164-1.0389.7912-2.1193 1.2492-3.1582l1.3325-2.9919 1.3326-2.7427c.3747-.7479.8328-1.4544 1.2492-2.1608l.7079-1.122.0417-.0415c.1249-.2078.1249-.2078.2498 0l.6246.7895 2.9982 3.8646 1.749 2.244 1.624 2.1193.0416.0415.0833.0416v-.0831l-.2498-.7065-1.2909-3.4906-1.4991-3.9892-1.6657-4.488c-.0416-.0831 0-.2077.0417-.2909l1.1659-1.6206 2.0821-2.6595 1.6656-1.9946 1.7906-2.0362 1.749-1.8285.1249-.1246.1666-.1662.0832.2077.7496 2.8258 1.4158 5.4437 1.2909 4.945.5413 2.0777.0417.0831h.0416l.0416-.0415v-.0416l.0417-.5402.0416-1.4544.0833-1.8284.0833-1.8284.0833-1.8284.0833-1.7869.0832-1.87.0833-1.7868.0833-1.87.0833-1.7869.0833-1.8284.0833-1.7868.1249-.2494 2.4568-1.9946c1.4575-1.1635 2.9982-2.2855 4.5389-3.3244l1.2493-.8311c.1665-.1247.1666-.0831.1666.0831l.0416.3325.0833 1.5375v.2909l.0833 1.4959.0416 1.122.0833 1.4544v.1663l.0833 1.5791v.0831l.0416 1.4128.0833 1.7453.0833 1.7038.0832 1.8284.0417.7064.0416.1663.0417.0415h.0416l.0417-.1662 1.4158-5.3606 1.3325-5.1528 1.6656-6.3579.4998-1.9946c0-.1247.0832-.2078.2081-.291 1.2493-.6232 2.4985-1.2466 3.7478-1.7868a61.84 61.84 0 0 1 9.286-3.2828l3.2064-.7896 2.4985-.5402 2.8316-.4986a29.2086 29.2086 0 0 1 1.8739-.291L74.788.0832 75.8707 0c.3375.0029.6693.0876.9667.2468.2974.1593.5516.3883.7406.6674a2.0753 2.0753 0 0 1 .3748 1.7038L77.2032 6.15c-.4164 1.87-.9577 3.74-1.4991 5.5684l-1.4574 4.2386c-.5414 1.5791-1.1243 3.1166-1.749 4.6541l-1.7073 3.9477c-.6662 1.5376-1.4574 3.0336-2.207 4.5295a39.8611 39.8611 0 0 1-2.3735 4.0724c-1.2076 1.87-2.4985 3.6984-3.831 5.4853l-1.0411 1.3297c-.0416.0831-.1665.1247-.2914.1247l-1.0827-.0416h-.9161l-2.207-.0415-1.8739-.0416-2.0821-.0415-1.9988-.0416-2.1237-.0416-1.6656-.0415h-.1666l-.0833.0415.0833.0832 1.8739.6233 4.1641 1.3713 4.997 1.6622c.2082.0831.2498.0831.0833.2493l-.9162.9973-2.7066 2.8258-2.2487 2.2024-1.6656 1.5375-2.2487 1.9531a86.8349 86.8349 0 0 1-5.0802 3.9477 23.3375 23.3375 0 0 1-2.7484 1.7038l-3.0398 1.6206a63.2047 63.2047 0 0 1-13.7417 5.0281c-1.4158.3325-2.8316.6649-4.2474.9143h-.1665l.0416-.0832.6662-.8311 1.6241-1.9946 2.1653-2.6595 1.8739-2.2855 1.7906-2.2024 1.5823-1.9531 1.9988-2.4518 1.2909-1.6206 1.7906-2.2024 2.1653-2.6595 1.9988-2.4518 1.2909-1.579 1.624-1.9947 1.6241-1.9531 1.9155-2.2855 1.9987-2.4517 2.1654-2.6595 1.9155-2.3271 1.9988-2.4102 1.9155-2.3686 1.749-2.1609 1.5823-1.9531 1.7489-2.1608 2.1654-2.618.4997-.6233.0416-.0415h-.0832l-.5414.5402a12.0896 12.0896 0 0 0-.7079.7895l-1.4574 1.5375-1.8323 1.9531-1.7072 1.8284-1.749 1.9116-1.624 1.7453-1.8322 1.9115-1.6657 1.7869-1.8322 1.953-1.7073 1.8284-1.7489 1.87-1.6657 1.7869-1.7073 1.8284-1.7489 1.87-1.749 1.8699-1.7489 1.8285-1.7073 1.8284-1.7073 1.8284-1.749 1.8284-1.7489 1.87-1.7489 1.8699-1.749 1.8285-1.7489 1.8699-1.6657 1.7453-1.7489 1.87-1.7073 1.87-1.7489 1.8699-1.7073 1.8285-1.7073 1.8284-.9578 1.0389-1.3742 1.4959-1.2492 1.496a34.0827 34.0827 0 0 0-1.7073 2.0362l-2.5818 3.3244-.8328 1.122c-.4164.5402-1.041.8311-1.7073.8311a2.2943 2.2943 0 0 1-1.6984-.5792 2.2843 2.2843 0 0 1-.7584-1.6233L0 75.2975Z"
              fill="#262626"
            ></path>
          </svg>
          <p
            class="
              ac--text
              text--align__center
              text--weight__regular
              text--size__regular
              logo-box--slang
            "
            dir="auto"
            auto-dir="auto"
          >
            تجربه&zwnj;ی لذت&zwnj;بخش از آموزش و یادگیری
          </p>
        </div>
        <p
          class="
            ac--text
            text--align__center
            text--weight__regular
            text--size__normal
            sign-in--hint
          "
          dir="auto"
          auto-dir="auto"
        >
          {{ login_msg }}
        </p>
        <div class="sign-in--phone-box">
          <v-alert
            v-if="error"
            rtl
            border="left"
            dense
            elevation="1"
            type="error"
            >{{ error }}</v-alert
          >
          <v-alert
            v-if="success"
            rtl
            border="left"
            dense
            elevation="1"
            type="success"
            >{{ success }}
          </v-alert>

          <v-otp-input
          @finish="signIn"
            reverse
            v-model="code"
            v-if="action == 1 && stage == 1"
            length="4"
            type="number"
          >
          </v-otp-input>
          <div
            v-if="action == 1 && stage == 1"
            class="text-center mt-2 code-resend"
            @click="resendCode"
          >
            {{ code_resend }}
          </div>

          <v-text-field
          @keyup.13="signIn"
            reverse
            class="centered-input"
            v-if="stage == 0"
            filled
            rounded
            solo
            dense
            v-model="phone"
            :rules="[
              () => !!phone || 'این فیلد الزامی است',
              () => !!validPhone || 'شماره موبایل صحیح نمی باشد',
            ]"
            required
            label="09123456789"
            prepend-inner-icon="mdi-phone"
          ></v-text-field>

          <v-text-field
          @keyup.13="signIn"

            reverse
            v-if="action == 0 && stage == 1"
            class="centered-input"
            filled
            rounded
            solo
            dense
            v-model="password"
            name="password"
            :rules="[() => !!password || 'این فیلد الزامی است']"
            :type="show1 ? 'text' : 'password'"
            @click:append="show1 = !show1"
            required
            label="کلمه عبور"
            prepend-inner-icon="mdi-cursor-text"
          ></v-text-field>

          <v-text-field
          @keyup.13="signIn"

            reverse
            v-if="action == 1 && stage == 2"
            filled
            rounded
            solo
            dense
            v-model="name"
            :rules="[() => !!name || 'این فیلد الزامی است']"
            required
            label="نام شما"
            class="centered-input"
            prepend-inner-icon="mdi-account"
          >
          </v-text-field>

          <v-text-field
          @keyup.13="signIn"

            reverse
            v-if="action == 1 && stage == 2"
            class="centered-input"
            filled
            rounded
            solo
            dense
            v-model="password"
            name="password"
            :rules="[
              () => !!password || 'این فیلد الزامی است',
              () => !!validPassword || 'رمز عبور حداقل 6 رقمی باشد',
            ]"
            :type="show1 ? 'text' : 'password'"
            @click:append="show1 = !show1"
            required
            label="کلمه عبور"
            prepend-inner-icon="mdi-cursor-text"
          ></v-text-field>

          <v-text-field
          @keyup.13="signIn"

            reverse
            v-if="action == 1 && stage == 2"
            class="centered-input"
            filled
            rounded
            solo
            dense
            v-model="confirm_password"
            name="confirm_password"
            :rules="[
              () =>
                !!(confirm_password == password) ||
                'رمز عبور با تکرار آن مطابقت ندارد',
            ]"
            :type="show2 ? 'text' : 'password'"
            @click:prepend="show2 = !show2"
            required
            label="تکرار کلمه عبور"
            prepend-inner-icon="mdi-cursor-text"
          ></v-text-field>
        </div>
      

        <v-btn
          v-if="stage == 0"
          rounded
          depressed
          style="margin-top: auto"
          :loading="loading"
          :disabled="!validPhone || loading"
          color="primary"
          @click="signIn"
        >
          بعدی
        </v-btn>
        <v-btn
          v-if="stage == 1 && action == 1"
          rounded
          depressed
          style="margin-top: auto"
          :loading="loading"
          :disabled="!validCode || loading"
          color="primary"
          @click="signIn"
        >
          بعدی
        </v-btn>
        <v-btn
          v-if="stage == 2 && action == 1"
          rounded
          depressed
          style="margin-top: auto"
          :loading="loading"
          :disabled="!validFinal || loading"
          color="primary"
          @click="signIn"
        >
          تکمیل ثبت نام
        </v-btn>
        <v-btn
          v-if="stage == 1 && action == 0"
          rounded
          depressed
          style="margin-top: auto"
          :loading="loading"
          :disabled="!validLogin || loading"
          color="primary"
          @click="signIn"
        >
          ورود
        </v-btn>
      </div>
    </div>
  </div>
</template>
<script>
export default {
  transition: {
    afterLeave(el) {},
  },
  loading: {
    color: 'blue',
    height: '5px'
  },
  name: "Login",
  data() {
    return {
      login_msg: "شماره تلفن همراه خود را وارد کنید",
      stage: 0,
      show2: false,
      show1: false,
      action: 0,
      code: "",
      phone: "09004101377",
      loading: false,
      code_resend: "ارسال کد",
      remain: 60,
      error: "",
      name: "",
      success: "",
      password: "",
      confirm_password: "",
    };
  },

  metaInfo: {
    title: "ورود به پنل کاربری - دکترشو",
  },
  methods: {
    refresh() {
      this.$nuxt.refresh();
    },
    async resendCode() {
      this.error = "";
      this.success = "";
      if (this.remain != 61) {
        return 0;
      }
      try {
        var resend = await this.$axios
          .post("register/resend-code", { phone: this.phone })
          .then((res) => res.data);

        if (resend.success == 0) {
          this.error = resend.msg;
        } else {
          this.success = "کد ارسال شد";

          var timer = setInterval(() => {
            this.remain--;
            this.code_resend =
              "ارسال مجدد کد در 00:" +
              (this.remain < 10 ? `0${this.remain}` : this.remain);
            if (this.remain == 0) {
              clearInterval(timer);
              this.code_resend = "ارسال مجدد کد";
              this.remain = 61;
            }
          }, 1000);
        }

        //this.error = (check.action);
      } catch (e) {
        console.log(e);
        this.error = "خطایی رخ داده لطفا بعدا تلاش کنید";
      }
    },
    async signIn() {
      this.error = "";
      this.success = "";

      if (this.stage == 0) {
         if(!this.validPhone || this.loading){
          return 0;
        }
      this.loading = true;

        try {

          var check = await this.$axios
            .get("login/check?phone=" + this.phone)
            .then((res) => res.data);

          this.action = check.action;
          if (check.success == 0) {
            this.error = check.msg;
          }else{
            this.stage = 1;

          if (this.action == 1) {
            var timer = setInterval(() => {
              this.remain--;
              this.code_resend =
                "ارسال مجدد کد در 00:" +
                (this.remain < 10 ? `0${this.remain}` : this.remain);
              if (this.remain == 0) {
                clearInterval(timer);
                this.code_resend = "ارسال مجدد کد";
                this.remain = 61;
              }
            }, 1000);

            this.login_msg = "کد ارسال شده را وارد نمایید";
            this.success = "کد به " + this.phone + " ارسال شد";
          } else {
            this.login_msg = "رمز عبور خود را وارد کنید";
          }
          }
          
          

          //this.error = (check.action);
        } catch (e) {
          console.log(e);
          this.error = "خطایی رخ داده لطفا بعدا تلاش کنید";
        }
      }
      //login
      else if (this.stage == 1 && this.action == 0) {
         if(!this.validLogin || this.loading){
          return 0;
        }
      this.loading = true;

        try {

          var login = await this.$auth
            .loginWith("laravelJWT", {
              data: {
                phone: this.phone,
                password: this.password,
              },
            })
            .then((res) => res.data);
          if (login.success) {
            this.success = "در حال ورود ...";
            this.stage = 2;
            setTimeout(()=>{  this.$router.push("/panel")}, 2000)
         
          } else {
            this.success = login.msg;
          }

          //this.error = (check.action);
        } catch (e) {
          console.log(e);
          this.error = "اطلاعات نادرست است";
        }
      }
      //register => to verify code
      else if (this.stage == 1 && this.action == 1) {
         if(!this.validCode || this.loading){
          return 0;
        }
      this.loading = true;

        try {
          var verify = await this.$axios
            .post("register/verify-code", {
              phone: this.phone,
              code: this.code,
            })
            .then((res) => res.data);

          if (!verify.success) {
            this.error = verify.msg;
          } else {
            this.stage = 2;
            this.login_msg = "نام خود را به همراه رمزعبور جدید وارد نمایید";
          }

          //this.error = (check.action);
        } catch (e) {
          console.log(e);
          this.error = "خطایی رخ داده لطفا بعدا تلاش کنید";
        }
      }
      //register => finish
      else if (this.stage == 2 && this.action == 1) {
         if(!this.validFinal || this.loading){
          return 0;
        }
      this.loading = true;

        try {
          var finish = await this.$axios
            .post("register/finish", {
              phone: this.phone,
              code: this.code,
              name: this.name,
              password: this.password,
              confirm_password: this.confirm_password,
            })
            .then((res) => res.data);

          if (finish.success) {
            this.stage = 3;
            this.login_msg = "اتمام ثبت نام";
            this.success = finish.msg;
            this.$auth.setUserToken(finish.token, finish.token);
            setTimeout(()=>{this.$router.push("/panel")}, 2000)
            
          } else {
            this.success = finish.msg;
          }

          //this.error = (check.action);
        } catch (e) {
          console.log(e);
          this.error = "خطایی رخ داده لطفا بعدا تلاش کنید";
        }
      }

      this.loading = false;
    },
  },

  computed: {
    validPhone() {
      if (this.phone.length == 11 && this.phone.startsWith("09")) {
        return true;
      }
      return false;
    },
    validCode() {
      if (this.code.length == 4) {
        return true;
      }
      return false;
    },
    validPassword() {
      if (this.password.length >= 6) {
        return true;
      }
      return false;
    },
    validLogin() {
      if (this.password) {
        return true;
      }
      return false;
    },

    validFinal() {
      if (
        this.password.length == this.confirm_password.length &&
        this.name &&
        this.validPassword
      ) {
        return true;
      }
      return false;
    },
  },
  fetchOnServer: true,
};
</script>
<style>
.v-text-field.centered-input input {
  text-align: center;
}

.code-resend {
  font-weight: 600;
  cursor: pointer;
}
</style>
<style lang="scss">
.v-text-field.centered-input .v-label {
  left: 50% !important;
  transform: translateX(-50%);
  text-align: center;

  &.v-label--active {
    transform: translateY(-18px) scale(0.75) translateX(-50%);
  }
}
</style>